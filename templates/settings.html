<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IDS Thời Gian Thực - Cài đặt</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">IDS Thời Gian Thực</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Bảng điều khiển</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/logs">Nhật ký</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/settings">Cài đặt</a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/logout">Đăng xuất</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="alert alert-success d-none" id="save-success">
            Lưu cài đặt thành công!
        </div>
        <div class="alert alert-danger d-none" id="save-error">
            Lỗi khi lưu cài đặt!
        </div>
        
    <form id="settings-form" novalidate>
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Cài đặt mạng</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="interface" class="form-label">Giao diện mạng</label>
                                <input type="text" class="form-control" id="interface" name="interface" value="{{ settings.network.interface }}">
                                <div class="form-text">Giao diện sẽ giám sát (ví dụ: eth0, wlan0)</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="window" class="form-label">Cửa sổ phân tích (giây)</label>
                                <input type="number" class="form-control" id="window" name="window" value="{{ settings.network.window }}">
                                <div class="form-text">Khoảng thời gian gom & phân tích lưu lượng</div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="min_packets" class="form-label">Số gói tối thiểu</label>
                                <input type="number" class="form-control" id="min_packets" name="min_packets" value="{{ settings.network.min_packets }}">
                                <div class="form-text">Số gói tối thiểu để phân tích một luồng</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="min_bytes" class="form-label">Bytes tối thiểu</label>
                                <input type="number" class="form-control" id="min_bytes" name="min_bytes" value="{{ settings.network.min_bytes }}">
                                <div class="form-text">Số byte tối thiểu để phân tích một luồng</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Cài đặt mô hình</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="model_path" class="form-label">Đường dẫn mô hình</label>
                                <input type="text" class="form-control" id="model_path" name="model_path" value="{{ settings.model.model_path }}">
                                <div class="form-text">Đường dẫn tới mô hình đã huấn luyện (.h5)</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="preprocess_path" class="form-label">Đường dẫn tiền xử lý</label>
                                <input type="text" class="form-control" id="preprocess_path" name="preprocess_path" value="{{ settings.model.preprocess_path }}">
                                <div class="form-text">Đường dẫn pipeline tiền xử lý (.pkl)</div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="threshold" class="form-label">Ngưỡng cảnh báo</label>
                                <input type="text" class="form-control" id="threshold" name="threshold" value="{{ settings.model.threshold }}" autocomplete="off" inputmode="decimal" placeholder="0.50">
                                <div class="form-text">Ngưỡng xác suất sinh cảnh báo (0-1). Có thể nhập 0.5 hoặc 0,5</div>
                                <div class="invalid-feedback" id="threshold-error">Giá trị phải nằm trong khoảng 0 - 1</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Cài đặt thông báo</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="enable_email" name="enable_email" {% if settings.notification.enable_email %}checked{% endif %}>
                        <label class="form-check-label" for="enable_email">Bật thông báo Email</label>
                    </div>
                    
                    <div id="email-settings" class="{% if not settings.notification.enable_email %}d-none{% endif %}">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="email_sender" class="form-label">Email gửi</label>
                                    <input type="email" class="form-control" id="email_sender" name="email_sender" value="{{ settings.notification.email_sender }}">
                                    <div class="form-text">Địa chỉ Gmail của bạn</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="email_password" class="form-label">Mật khẩu ứng dụng</label>
                                    <input type="password" class="form-control" id="email_password" name="email_password" placeholder="Your Gmail app password">
                                    <div class="form-text">Mật khẩu ứng dụng Gmail (khác mật khẩu đăng nhập)</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="email_recipient" class="form-label">Email nhận</label>
                                    <input type="email" class="form-control" id="email_recipient" name="email_recipient" value="{{ settings.notification.email_recipient }}">
                                    <div class="form-text">Email sẽ nhận thông báo</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="email_interval" class="form-label">Khoảng cách Email (giây)</label>
                                    <input type="number" class="form-control" id="email_interval" name="email_interval" value="{{ settings.notification.email_interval }}">
                                    <div class="form-text">Thời gian tối thiểu giữa các email</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="enable_telegram" name="enable_telegram" {% if settings.notification.enable_telegram %}checked{% endif %}>
                        <label class="form-check-label" for="enable_telegram">Bật thông báo Telegram</label>
                    </div>
                    
                    <div id="telegram-settings" class="{% if not settings.notification.enable_telegram %}d-none{% endif %}">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="telegram_token" class="form-label">Token Bot Telegram</label>
                                    <input type="text" class="form-control" id="telegram_token" name="telegram_token" placeholder="Your bot token">
                                    <div class="form-text">Token lấy từ BotFather (@BotFather)</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="telegram_chat_id" class="form-label">Chat ID</label>
                                    <input type="text" class="form-control" id="telegram_chat_id" name="telegram_chat_id" value="{{ settings.notification.telegram_chat_id }}">
                                    <div class="form-text">Chat ID cá nhân hoặc nhóm</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="telegram_interval" class="form-label">Khoảng cách Telegram (giây)</label>
                                    <input type="number" class="form-control" id="telegram_interval" name="telegram_interval" value="{{ settings.notification.telegram_interval }}">
                                    <div class="form-text">Thời gian tối thiểu giữa các thông báo Telegram</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-4">
                <button type="submit" id="save-btn" class="btn btn-primary px-4">
                    <span class="save-text">Lưu cài đặt</span>
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                </button>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('settings-form');
            const enableEmail = document.getElementById('enable_email');
            const emailSettings = document.getElementById('email-settings');
            const enableTelegram = document.getElementById('enable_telegram');
            const telegramSettings = document.getElementById('telegram-settings');
            const saveSuccess = document.getElementById('save-success');
            const saveError = document.getElementById('save-error');
            
            // Toggle email settings visibility
            enableEmail.addEventListener('change', function() {
                if (this.checked) {
                    emailSettings.classList.remove('d-none');
                } else {
                    emailSettings.classList.add('d-none');
                }
            });
            
            // Toggle telegram settings visibility
            enableTelegram.addEventListener('change', function() {
                if (this.checked) {
                    telegramSettings.classList.remove('d-none');
                } else {
                    telegramSettings.classList.add('d-none');
                }
            });
            
            // Helper: parse int/float an toàn
            function safeInt(v) { const n = parseInt(v, 10); return Number.isFinite(n) ? n : undefined; }
            function safeFloat(v) { const n = parseFloat(v); return Number.isFinite(n) ? n : undefined; }
            function prune(obj) {
                Object.keys(obj).forEach(k => {
                    const v = obj[k];
                    if (v === '' || v === undefined || v === null || (typeof v === 'number' && !Number.isFinite(v))) {
                        delete obj[k];
                    }
                });
                return obj;
            }

            const saveBtn = document.getElementById('save-btn');
            const spinner = saveBtn.querySelector('.spinner-border');
            const saveText = saveBtn.querySelector('.save-text');

            form.addEventListener('submit', function(e) {
                e.preventDefault();

                // Tránh double click
                if (saveBtn.disabled) return;
                saveBtn.disabled = true;
                spinner.classList.remove('d-none');
                saveText.textContent = 'Đang lưu...';

                // Chuẩn hoá giá trị số trước
                const sanitizeNumber = v => {
                    if (v == null) return '';
                    v = v.trim().replace(',', '.');
                    return v;
                };

                // Xử lý riêng threshold để tránh HTML5 chặn submit khi format sai
                const thresholdInput = document.getElementById('threshold');
                thresholdInput.value = sanitizeNumber(thresholdInput.value);

                const formData = new FormData(form);
                const network = prune({
                    interface: formData.get('interface'),
                    window: safeInt(formData.get('window')),
                    min_packets: safeInt(formData.get('min_packets')),
                    min_bytes: safeInt(formData.get('min_bytes'))
                });
                // Parse threshold với fallback
                let thrRaw = formData.get('threshold');
                thrRaw = sanitizeNumber(thrRaw);
                let thrVal = safeFloat(thrRaw);
                let thresholdError = false;
                if (thrVal !== undefined) {
                    if (thrVal < 0 || thrVal > 1) {
                        thresholdError = true;
                    }
                }
                const model = prune({
                    model_path: formData.get('model_path'),
                    preprocess_path: formData.get('preprocess_path'),
                    threshold: thrVal
                });

                if (thresholdError) {
                    const err = document.getElementById('threshold-error');
                    thresholdInput.classList.add('is-invalid');
                    err.classList.remove('d-none');
                    saveBtn.disabled = false;
                    spinner.classList.add('d-none');
                    saveText.textContent = 'Lưu cài đặt';
                    return;
                } else {
                    thresholdInput.classList.remove('is-invalid');
                }
                const notification = prune({
                    enable_email: formData.get('enable_email') === 'on',
                    email_sender: formData.get('email_sender'),
                    email_password: formData.get('email_password'), // sẽ bị prune nếu rỗng
                    email_recipient: formData.get('email_recipient'),
                    email_interval: safeInt(formData.get('email_interval')),
                    enable_telegram: formData.get('enable_telegram') === 'on',
                    telegram_token: formData.get('telegram_token'),
                    telegram_chat_id: formData.get('telegram_chat_id'),
                    telegram_interval: safeInt(formData.get('telegram_interval'))
                });

                const payload = { network, model, notification };

                fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(r => r.ok ? r.json() : Promise.reject(r.status))
                .then(data => {
                    if (data.success) {
                        saveSuccess.classList.remove('d-none');
                        saveError.classList.add('d-none');
                        setTimeout(() => saveSuccess.classList.add('d-none'), 3000);
                    } else {
                        saveError.classList.remove('d-none');
                        saveSuccess.classList.add('d-none');
                    }
                })
                .catch(err => {
                    console.error('Save error:', err);
                    saveError.classList.remove('d-none');
                    saveSuccess.classList.add('d-none');
                })
                .finally(() => {
                    saveBtn.disabled = false;
                    spinner.classList.add('d-none');
                    saveText.textContent = 'Lưu cài đặt';
                });
            });
        });
    </script>
</body>
</html>